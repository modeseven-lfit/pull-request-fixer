---
# SPDX-License-Identifier: Apache-2.0
# SPDX-FileCopyrightText: 2025 The Linux Foundation

# Action test/validation workflow
name: "Test GitHub Action ðŸ§ª"

# yamllint disable-line rule:truthy
on:
  workflow_dispatch:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

concurrency:
  group: "${{ github.workflow }}-${{ github.ref }}"
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: read

jobs:
  ### Build the Python package ###
  python-build:
    name: 'Build Python Package'
    runs-on: 'ubuntu-latest'
    outputs:
      matrix_json: "${{ steps.python-build.outputs.matrix_json }}"
      artefact_name: "${{ steps.python-build.outputs.artefact_name }}"
      artefact_path: "${{ steps.python-build.outputs.artefact_path }}"
    permissions:
      contents: read
    timeout-minutes: 12
    env:
      GH_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
    steps:
      # Harden the runner used by this workflow
      # yamllint disable-line rule:line-length
      - uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76  # v2.14.0
        with:
          egress-policy: 'audit'

      # yamllint disable-line rule:line-length
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6.0.1

      - name: 'Build Python project'
        id: python-build
        # yamllint disable-line rule:line-length
        uses: lfreleng-actions/python-build-action@8f567398591014dd5627961aaa9ec17816b072f0  # v1.0.2
        with:
          clear_cache: 'false'

  ### Test the CLI Tool ###
  cli-tests:
    name: "Test CLI Tool"
    runs-on: ubuntu-latest
    needs: python-build
    permissions:
      contents: read
      pull-requests: read
    timeout-minutes: 10
    steps:
      # Harden the runner used by this workflow
      # yamllint disable-line rule:line-length
      - uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: "Checkout repository"
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: "Install uv"
        # yamllint disable-line rule:line-length
        uses: astral-sh/setup-uv@681c641aba71e4a1c380be3ab5e12ad51f415867 # v7.1.6
        with:
          enable-cache: true

      - name: "Install package with uv"
        shell: bash
        run: |
          # Install the tool using uv
          uv tool install .

      - name: "Test CLI help"
        shell: bash
        run: |
          # Test that the CLI is installed and working
          pull-request-fixer --version
          pull-request-fixer --help

      - name: "Run unit tests"
        shell: bash
        run: |
          # Run pytest tests if they exist
          if [ -f "tests/test_graphql_queries.py" ]; then
            uv run pytest tests/test_graphql_queries.py -v || true
          fi

  ### Test against local GitHub organization ###
  integration-test:
    name: "Integration Test"
    runs-on: ubuntu-latest
    needs: python-build
    permissions:
      contents: read
      pull-requests: read
    timeout-minutes: 15
    steps:
      # Harden the runner used by this workflow
      # yamllint disable-line rule:line-length
      - uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: "Checkout repository"
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: "Install uv"
        # yamllint disable-line rule:line-length
        uses: astral-sh/setup-uv@681c641aba71e4a1c380be3ab5e12ad51f415867 # v7.1.6
        with:
          enable-cache: true

      - name: "Install package with uv"
        shell: bash
        run: |
          # Install the tool using uv
          uv tool install .

      - name: "Test GraphQL queries with debug script"
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Run debug script to validate GraphQL queries
          echo "## GraphQL Query Validation" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          uv run python scripts/debug_graphql.py \
            --org "${{ github.repository_owner }}" 2>&1 | tee debug.log

          # Add results to summary
          if grep -q "âœ… Query successful" debug.log; then
            echo "âœ… GraphQL queries working correctly" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "âš ï¸ GraphQL query issues detected - see logs" \
              >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: "Scan organization for pull requests"
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Test scanning the organization in dry-run mode
          echo "## Organization Scan Test" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "Testing scan of organization: ${{ github.repository_owner }}" \
            >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          pull-request-fixer "${{ github.repository_owner }}" \
            --fix-title \
            --dry-run \
            --verbose \
            2>&1 | tee scan.log

          # Extract key metrics from output
          if grep -q "Found.*open PRs" scan.log; then
            grep "Found.*open PRs" scan.log >> "$GITHUB_STEP_SUMMARY"
          fi

          if grep -q "Found.*PRs with title mismatches" scan.log; then
            grep "Found.*PRs with title mismatches" scan.log \
              >> "$GITHUB_STEP_SUMMARY"
          fi

          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "âœ… Dry-run scan completed successfully" >> "$GITHUB_STEP_SUMMARY"

      - name: "Upload test logs"
        # yamllint disable-line rule:line-length
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        if: always()
        with:
          name: test-logs
          path: |
            debug.log
            scan.log
          retention-days: 30
